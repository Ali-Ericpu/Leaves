From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Wed, 17 Aug 2022 10:56:49 +0800
Subject: [PATCH] Remove lambda from ticking guard

This patch is Powered by Pufferfish(https://github.com/pufferfish-gg/Pufferfish)

diff --git a/src/main/java/net/minecraft/server/level/ServerLevel.java b/src/main/java/net/minecraft/server/level/ServerLevel.java
index 114bc179c5ff436801c4f6bfeacf71c74d4d3f37..7dac4b8c61db0bbce81a8fd85ed8779629517a9c 100644
--- a/src/main/java/net/minecraft/server/level/ServerLevel.java
+++ b/src/main/java/net/minecraft/server/level/ServerLevel.java
@@ -725,7 +725,24 @@ public class ServerLevel extends Level implements WorldGenLevel {
                             }
 
                             gameprofilerfiller.push("tick");
-                            this.guardEntityTick(this::tickNonPassenger, entity);
+                            // Leaves start - copied from this.guardEntityTick
+                            if (top.leavesmc.leaves.LeavesConfig.removeTickGuardLambda) {
+                                try {
+                                    this.tickNonPassenger(entity); // Leaves - changed
+                                    MinecraftServer.getServer().executeMidTickTasks(); // Tuinity - execute chunk tasks mid tick
+                                } catch (Throwable throwable) {
+                                    if (throwable instanceof ThreadDeath) throw throwable; // Paper
+                                    // Paper start - Prevent tile entity and entity crashes
+                                    final String msg = String.format("Entity threw exception at %s:%s,%s,%s", entity.level.getWorld().getName(), entity.getX(), entity.getY(), entity.getZ());
+                                    MinecraftServer.LOGGER.error(msg, throwable);
+                                    getCraftServer().getPluginManager().callEvent(new com.destroystokyo.paper.event.server.ServerExceptionEvent(new com.destroystokyo.paper.exception.ServerInternalException(msg, throwable)));
+                                    entity.discard();
+                                    // Paper end
+                                }
+                            } else {
+                                this.guardEntityTick(this::tickNonPassenger, entity);
+                            }
+                            // Leaves end - copied from this.guardEntityTick
                             gameprofilerfiller.pop();
                         }
                     }
diff --git a/src/main/java/top/leavesmc/leaves/LeavesConfig.java b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
index a557ea7adbb82dfff5c383b1d9acb8e0487fd4e9..92fae1f8b08038d4451643aaedaa63a000a32034 100644
--- a/src/main/java/top/leavesmc/leaves/LeavesConfig.java
+++ b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
@@ -320,6 +320,11 @@ public final class LeavesConfig {
         reduceEntityAllocations = getBoolean("settings.performance.reduce-entity-allocations", reduceEntityAllocations);
     }
 
+    public static boolean removeTickGuardLambda = true;
+    private static void removeTickGuardLambda() {
+        removeTickGuardLambda = getBoolean("settings.performance.remove.tick-guard-lambda", removeTickGuardLambda);
+    }
+
     public static final class WorldConfig {
 
         public final String worldName;
