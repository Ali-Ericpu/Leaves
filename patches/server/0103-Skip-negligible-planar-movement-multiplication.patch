From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Fri, 21 Jul 2023 11:47:59 +0800
Subject: [PATCH] Skip negligible planar movement multiplication

This patch is Powered by Gale(https://github.com/GaleMC/Gale)

diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 98570eb6c9c42bba4daf32d447c29650cfcd4de7..295f16965ef33c6369303b3c9a19be047223afaa 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -1218,9 +1218,16 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource, S
                 }
 
                 this.tryCheckInsideBlocks();
-                float f = this.getBlockSpeedFactor();
-
-                this.setDeltaMovement(this.getDeltaMovement().multiply((double) f, 1.0D, (double) f));
+                // Leaves start - skip negligible planar movement multiplication
+                Vec3 oldDeltaMovement = this.getDeltaMovement();
+                if (!top.leavesmc.leaves.LeavesConfig.skipNegligiblePlanarMovementMultiplication ||
+                    (oldDeltaMovement.x < -1e-6 || oldDeltaMovement.x > 1e-6 || oldDeltaMovement.z < -1e-6 || oldDeltaMovement.z > 1e-6)) {
+                    float f = this.getBlockSpeedFactor();
+                    if (!top.leavesmc.leaves.LeavesConfig.skipNegligiblePlanarMovementMultiplication || (f < 1 - 1e-6 || f > 1 + 1e-6)) {
+                        this.setDeltaMovement(this.getDeltaMovement().multiply((double) f, 1.0D, (double) f));
+                    }
+                }
+                // Leaves end - skip negligible planar movement multiplication
                 // Paper start - remove expensive streams from here
                 boolean noneMatch = true;
                 AABB fireSearchBox = this.getBoundingBox().deflate(1.0E-6D);
