From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Sun, 21 Aug 2022 08:29:15 +0800
Subject: [PATCH] Reduce chunk loading & lookups

This patch is Powered by Pufferfish(https://github.com/pufferfish-gg/Pufferfish)

diff --git a/src/main/java/net/minecraft/world/entity/monster/EnderMan.java b/src/main/java/net/minecraft/world/entity/monster/EnderMan.java
index f4002ac7cba7d5e41b4f11b98212c625f6a92a65..6feeb3d30e45c5aba4e8204fe7e76f8f0357ad08 100644
--- a/src/main/java/net/minecraft/world/entity/monster/EnderMan.java
+++ b/src/main/java/net/minecraft/world/entity/monster/EnderMan.java
@@ -322,11 +322,28 @@ public class EnderMan extends Monster implements NeutralMob {
     private boolean teleport(double x, double y, double z) {
         BlockPos.MutableBlockPos blockposition_mutableblockposition = new BlockPos.MutableBlockPos(x, y, z);
 
-        while (blockposition_mutableblockposition.getY() > this.level.getMinBuildHeight() && !this.level.getBlockState(blockposition_mutableblockposition).getMaterial().blocksMotion()) {
-            blockposition_mutableblockposition.move(Direction.DOWN);
+        // Leaves start - single chunk lookup
+        BlockState iblockdata;
+        if (top.leavesmc.leaves.LeavesConfig.reduceChuckLoadAndLookup) {
+            net.minecraft.world.level.chunk.LevelChunk chunk = this.level.getChunkIfLoaded(blockposition_mutableblockposition);
+            if (chunk == null) {
+                return false;
+            }
+
+            while (blockposition_mutableblockposition.getY() > this.level.getMinBuildHeight() && !chunk.getBlockState(blockposition_mutableblockposition).getMaterial().blocksMotion()) {
+                blockposition_mutableblockposition.move(Direction.DOWN);
+            }
+
+            iblockdata = chunk.getBlockState(blockposition_mutableblockposition);
+        } else {
+            while (blockposition_mutableblockposition.getY() > this.level.getMinBuildHeight() && !this.level.getBlockState(blockposition_mutableblockposition).getMaterial().blocksMotion()) {
+                blockposition_mutableblockposition.move(Direction.DOWN);
+            }
+
+            iblockdata = this.level.getBlockState(blockposition_mutableblockposition);
         }
+        // Leaves end - single chunk lookup
 
-        BlockState iblockdata = this.level.getBlockState(blockposition_mutableblockposition);
         boolean flag = iblockdata.getMaterial().blocksMotion();
         boolean flag1 = iblockdata.getFluidState().is(FluidTags.WATER);
 
diff --git a/src/main/java/top/leavesmc/leaves/LeavesConfig.java b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
index 22b1a368313815d58cc04adb4e5368725bfa431f..a4b59a56a49a7f68b137cc6bc6ae935da6a38a82 100644
--- a/src/main/java/top/leavesmc/leaves/LeavesConfig.java
+++ b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
@@ -374,6 +374,11 @@ public final class LeavesConfig {
         reduceEntityFluidLookup = getBoolean("settings.performance.reduce-entity-fluid-lookup", reduceEntityFluidLookup);
     }
 
+    public static boolean reduceChuckLoadAndLookup = true;
+    private static void reduceChuckLoadAndLookup() {
+        reduceChuckLoadAndLookup = getBoolean("settings.performance.reduce-chuck-load-and-lookup", reduceChuckLoadAndLookup);
+    }
+
     public static final class WorldConfig {
 
         public final String worldName;
