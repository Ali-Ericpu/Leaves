From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Wed, 16 Feb 2022 12:42:14 +0800
Subject: [PATCH] Add fakeplayer action support


diff --git a/src/main/java/net/minecraft/world/entity/player/Player.java b/src/main/java/net/minecraft/world/entity/player/Player.java
index 9b131f0a827413e9f5d6d0f7491c5481576cb8b1..e2305caf0b3ce21810a31e05c943a6d859870bd5 100644
--- a/src/main/java/net/minecraft/world/entity/player/Player.java
+++ b/src/main/java/net/minecraft/world/entity/player/Player.java
@@ -1291,7 +1291,7 @@ public abstract class Player extends LivingEntity {
                     boolean flag3 = false;
                     double d0 = (double) (this.walkDist - this.walkDistO);
 
-                    if (flag && !flag2 && !flag1 && this.onGround && d0 < (double) this.getSpeed()) {
+                    if (flag && !flag2 && !flag1 && this.isOnGround() && d0 < (double) this.getSpeed()) { // Leaves - use isOnGround method
                         ItemStack itemstack = this.getItemInHand(InteractionHand.MAIN_HAND);
 
                         if (itemstack.getItem() instanceof SwordItem) {
diff --git a/src/main/java/top/leavesmc/leaves/LeavesConfig.java b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
index 898c61c25675232e203ee2c872ca25804c41358c..4d6d025c78086f186da710ae46f65eda5426464d 100644
--- a/src/main/java/top/leavesmc/leaves/LeavesConfig.java
+++ b/src/main/java/top/leavesmc/leaves/LeavesConfig.java
@@ -68,6 +68,7 @@ public final class LeavesConfig {
 
         if (top.leavesmc.leaves.LeavesConfig.fakeplayerSupport) {
             commands.put("bot", new BotCommand("bot"));
+            top.leavesmc.leaves.bot.agent.Actions.registerAll();
         }
     }
 
diff --git a/src/main/java/top/leavesmc/leaves/bot/BotCommand.java b/src/main/java/top/leavesmc/leaves/bot/BotCommand.java
index 28744e9065493c7764d0b7a8c5ec0883c21d8156..30cd739eef5e6314c692272e60a5af0bc01fe194 100644
--- a/src/main/java/top/leavesmc/leaves/bot/BotCommand.java
+++ b/src/main/java/top/leavesmc/leaves/bot/BotCommand.java
@@ -6,7 +6,11 @@ import org.bukkit.ChatColor;
 import org.bukkit.Location;
 import org.bukkit.command.Command;
 import org.bukkit.command.CommandSender;
+import org.bukkit.craftbukkit.entity.CraftPlayer;
 import org.bukkit.entity.Player;
+import top.leavesmc.leaves.bot.agent.Actions;
+import top.leavesmc.leaves.bot.agent.BotAction;
+import top.leavesmc.leaves.util.MathUtils;
 
 import java.util.ArrayList;
 import java.util.List;
@@ -16,7 +20,7 @@ public class BotCommand extends Command {
     public BotCommand(String name) {
         super(name);
         this.description = "FakePlayer Command";
-        this.usageMessage = "/bot [create | remove]";
+        this.usageMessage = "/bot [create | remove | action]";
         this.setPermission("bukkit.command.bot");
     }
 
@@ -27,13 +31,29 @@ public class BotCommand extends Command {
         if (args.length <= 1) {
             list.add("create");
             list.add("remove");
-        } else {
+            list.add("action");
+        }
+
+        if (args.length == 2) {
+            switch (args[0]) {
+                case "create" -> list.add("<BotName>");
+                case "remove", "action" -> list.addAll(ServerBot.getBots().stream().map(e -> e.getName().getString()).toList());
+            }
+        }
+
+        if (args.length == 3) {
+            switch (args[0]) {
+                case "action" -> list.addAll(Actions.getAll().stream().map(BotAction::getName).toList());
+            }
+        }
+
+        if (args.length == 4) {
             switch (args[0]) {
                 case "create" -> list.add("[BotName]");
                 case "remove" -> list.addAll(ServerBot.getBots().stream().map(e -> e.getName().getString()).toList());
+                case "action" -> list.add("[tickDelay]");
             }
         }
-
         return list;
     }
 
@@ -51,6 +71,8 @@ public class BotCommand extends Command {
 
             case "remove" -> this.onRemove(sender, args);
 
+            case "action" -> this.onAction(sender, args);
+
             default -> {
                 sender.sendMessage(ChatColor.RED + "Usage: " + usageMessage);
                 return false;
@@ -62,7 +84,7 @@ public class BotCommand extends Command {
 
     private void onCreate(CommandSender sender, String[] args) {
         if (args.length < 2) {
-            sender.sendMessage(ChatColor.RED + "Use /bot create [name] to create a fakeplayer");
+            sender.sendMessage(ChatColor.RED + "Use /bot create <name> to create a fakeplayer");
             return;
         }
 
@@ -90,7 +112,7 @@ public class BotCommand extends Command {
 
     private void onRemove(CommandSender sender, String[] args) {
         if (args.length < 2) {
-            sender.sendMessage(ChatColor.RED + "Use /bot remove [name] to remove a fakeplayer");
+            sender.sendMessage(ChatColor.RED + "Use /bot remove <name> to remove a fakeplayer");
             return;
         }
 
@@ -103,4 +125,31 @@ public class BotCommand extends Command {
 
         bot.die(DamageSource.OUT_OF_WORLD);
     }
+
+    private void onAction(CommandSender sender, String[] args) {
+        if (args.length < 3) {
+            sender.sendMessage(ChatColor.RED + "Use /bot action <name> <action> to make fakeplayer do action");
+	    return;
+        }
+
+        int tickDelay = 20;
+        if (args.length > 3 && MathUtils.isNumeric(args[3])) {
+            tickDelay = Integer.parseInt(args[3]);
+        }
+
+        ServerBot bot = ServerBot.getBot(args[1]);
+        BotAction action = Actions.getForName(args[2]);
+
+        if (bot == null) {
+            sender.sendMessage(ChatColor.RED + "This fakeplayer is null");
+            return;
+        }
+        if (action == null) {
+            sender.sendMessage(ChatColor.RED + "This action is null");
+            return;
+        }
+
+        bot.setBotAction(action.getNew(tickDelay, ((CraftPlayer) sender).getHandle()));
+        sender.sendMessage("Action set");
+    }
 }
diff --git a/src/main/java/top/leavesmc/leaves/bot/ServerBot.java b/src/main/java/top/leavesmc/leaves/bot/ServerBot.java
index 1451e0679bd305b429b6727b7e06257a0aadc102..49dea36ff835ea42d4475db9515f87bf134751bb 100644
--- a/src/main/java/top/leavesmc/leaves/bot/ServerBot.java
+++ b/src/main/java/top/leavesmc/leaves/bot/ServerBot.java
@@ -1,11 +1,14 @@
 package top.leavesmc.leaves.bot;
 
+import com.google.common.collect.Lists;
 import com.mojang.authlib.GameProfile;
 import com.mojang.authlib.properties.Property;
 import com.mojang.datafixers.util.Pair;
 import net.minecraft.Util;
+import com.mojang.datafixers.util.Pair;
 import io.netty.util.concurrent.Future;
 import io.netty.util.concurrent.GenericFutureListener;
+import net.minecraft.Util;
 import net.minecraft.network.Connection;
 import net.minecraft.network.PacketSendListener;
 import net.minecraft.network.protocol.Packet;
@@ -15,6 +18,7 @@ import net.minecraft.network.protocol.game.ClientboundPlayerInfoPacket;
 import net.minecraft.network.protocol.game.ClientboundRemoveEntitiesPacket;
 import net.minecraft.network.protocol.game.ClientboundRotateHeadPacket;
 import net.minecraft.network.protocol.game.ClientboundSetEntityDataPacket;
+import net.minecraft.network.protocol.game.ClientboundSetEquipmentPacket;
 import net.minecraft.network.syncher.EntityDataAccessor;
 import net.minecraft.network.syncher.EntityDataSerializers;
 import net.minecraft.server.MinecraftServer;
@@ -25,9 +29,13 @@ import net.minecraft.server.level.TicketType;
 import net.minecraft.server.network.ServerGamePacketListenerImpl;
 import net.minecraft.server.network.ServerPlayerConnection;
 import net.minecraft.util.Mth;
+import net.minecraft.world.InteractionHand;
 import net.minecraft.world.damagesource.DamageSource;
 import net.minecraft.world.entity.Entity;
+import net.minecraft.world.entity.EntityType;
+import net.minecraft.world.entity.EquipmentSlot;
 import net.minecraft.world.entity.MoverType;
+import net.minecraft.world.entity.item.ItemEntity;
 import net.minecraft.world.level.ChunkPos;
 import net.minecraft.world.level.chunk.LevelChunk;
 import net.minecraft.world.phys.AABB;
@@ -40,8 +48,10 @@ import org.bukkit.World;
 import org.bukkit.block.Block;
 import org.bukkit.craftbukkit.CraftWorld;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
+import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.craftbukkit.scheduler.MinecraftInternalPlugin;
 import org.bukkit.event.entity.CreatureSpawnEvent;
+import org.bukkit.inventory.ItemStack;
 import org.bukkit.plugin.Plugin;
 import org.bukkit.util.BoundingBox;
 import org.bukkit.util.Vector;
@@ -49,11 +59,15 @@ import org.jetbrains.annotations.NotNull;
 import top.leavesmc.leaves.entity.Bot;
 import top.leavesmc.leaves.entity.CraftBot;
 import top.leavesmc.leaves.event.bot.BotCreateEvent;
+import top.leavesmc.leaves.bot.agent.BotAction;
 import top.leavesmc.leaves.event.bot.BotJoinEvent;
 import top.leavesmc.leaves.util.MathUtils;
 
 import javax.annotation.Nullable;
+import java.util.ArrayList;
+import java.util.Collections;
 import java.util.HashSet;
+import java.util.List;
 import java.util.Objects;
 import java.util.Set;
 import java.util.UUID;
@@ -62,12 +76,17 @@ public class ServerBot extends ServerPlayer {
 
     private Vector velocity;
     private Vector oldVelocity;
+    private BotAction action;
+    private BotAction newAction;
 
     private boolean removeOnDeath;
-    private byte fireTicks;
-    private byte groundTicks;
-    private byte jumpTicks;
-    private byte noFallTicks;
+    private int fireTicks;
+    private int groundTicks;
+    private int jumpTicks;
+    private int noFallTicks;
+    private int noActionTicks;
+
+    private final ItemStack defaultItem;
 
     private static final Set<ServerBot> bots = new HashSet<>();
     private static final Plugin MINECRAFT_PLUGIN = new MinecraftInternalPlugin();
@@ -80,6 +99,8 @@ public class ServerBot extends ServerPlayer {
         this.oldVelocity = velocity.clone();
         this.noFallTicks = 60;
         this.fireTicks = 0;
+        this.noActionTicks = 0;
+        this.defaultItem = new ItemStack(Material.AIR);
         this.removeOnDeath = true;
     }
 
@@ -118,6 +139,7 @@ public class ServerBot extends ServerPlayer {
 
             bot.teleportTo(loc.getX(), loc.getY(), loc.getZ());
             bot.setRot(loc.getYaw(), loc.getPitch());
+            bot.getBukkitEntity().setRotation(loc.getYaw(), loc.getPitch());
             world.addFreshEntity(bot, CreatureSpawnEvent.SpawnReason.COMMAND);
 
             bot.renderAll();
@@ -185,12 +207,17 @@ public class ServerBot extends ServerPlayer {
         }
     }
 
+    private void removeTab() {
+        sendPacket(new ClientboundPlayerInfoPacket(ClientboundPlayerInfoPacket.Action.REMOVE_PLAYER, this));
+    }
+
     private void setDead() {
         sendPacket(new ClientboundRemoveEntitiesPacket(getId()));
         this.dead = true;
         this.inventoryMenu.removed(this);
         this.containerMenu.removed(this);
     }
+
     // die check end
 
     @Nullable
@@ -204,10 +231,6 @@ public class ServerBot extends ServerPlayer {
         return groundTicks != 0;
     }
 
-    private void removeTab() {
-        sendPacket(new ClientboundPlayerInfoPacket(ClientboundPlayerInfoPacket.Action.REMOVE_PLAYER, this));
-    }
-
     public static boolean solidAt(Location loc) {
         Block block = loc.getBlock();
         BoundingBox box = block.getBoundingBox();
@@ -302,12 +325,24 @@ public class ServerBot extends ServerPlayer {
     public void tick() {
         // loadChunks(); // Load chunks
         super.tick();
+        this.doTick();
 
-        if (!isAlive()) return;
+        if (!isAlive()) {
+            return;
+        }
 
-        if (fireTicks > 0) --fireTicks;
-        if (jumpTicks > 0) --jumpTicks;
-        if (noFallTicks > 0) --noFallTicks;
+        if (fireTicks > 0) {
+            --fireTicks;
+        }
+        if (jumpTicks > 0) {
+            --jumpTicks;
+        }
+        if (noFallTicks > 0) {
+            --noFallTicks;
+        }
+        if (noActionTicks > 0) {
+            --noActionTicks;
+        }
 
         if (checkGround()) {
             if (groundTicks < 5) groundTicks++;
@@ -335,7 +370,88 @@ public class ServerBot extends ServerPlayer {
 
         checkOutOfWorld();
 
+        ++this.attackStrengthTicker;
+
+        if (this.getHealth() > 0.0F) {
+            AABB axisalignedbb;
+
+            if (this.isPassenger() && !this.getVehicle().isRemoved()) {
+                axisalignedbb = this.getBoundingBox().minmax(this.getVehicle().getBoundingBox()).inflate(1.0D, 0.0D, 1.0D);
+            } else {
+                axisalignedbb = this.getBoundingBox().inflate(1.0D, 0.5D, 1.0D);
+            }
+
+            List<Entity> list = this.level.getEntities(this, axisalignedbb);
+            List<Entity> list1 = Lists.newArrayList();
+
+            for (Entity entity : list) {
+                if (entity.getType() == EntityType.EXPERIENCE_ORB) {
+                    list1.add(entity);
+                } else if (!entity.isRemoved()) {
+                    this.touch(entity);
+                }
+            }
+
+            if (!list1.isEmpty()) {
+                this.touch((Entity) Util.getRandom((List) list1, this.random));
+            }
+        }
+
         oldVelocity = velocity.clone();
+
+        if (newAction != null) {
+            action = newAction;
+            newAction = null;
+            noActionTicks = 0;
+        }
+
+        if (action != null && noActionTicks <= 0) {
+            if (action.isCancel()) {
+                action = null;
+            } else {
+                action.tick(this);
+                noActionTicks = action.getTickDelay();
+            }
+        }
+    }
+
+    private void touch(Entity entity) {
+        entity.playerTouch(this);
+    }
+
+    @Override
+    public void onItemPickup(ItemEntity item) {
+        super.onItemPickup(item);
+        this.updateItemInMainHand();
+    }
+
+    private ItemStack lastItem = new ItemStack(Material.AIR);
+    public void updateItemInMainHand() {
+        ItemStack item = this.getInventory().getSelected().asBukkitCopy();
+        if (!lastItem.isSimilar(item)) {
+            this.setItem(item, EquipmentSlot.MAINHAND);
+            lastItem = item;
+        }
+
+        if (item.getAmount() == 0) {
+            this.setItem(defaultItem, EquipmentSlot.MAINHAND);
+            lastItem = defaultItem;
+        }
+    }
+
+    @Override
+    public void doTick() {
+        if (this.hurtTime > 0) {
+            this.hurtTime -= 1;
+        }
+
+        baseTick();
+        tickEffects();
+
+        this.lerpSteps = (int) this.zza;
+        this.animStep = this.run;
+        this.yRotO = this.getYRot();
+        this.xRotO = this.getXRot();
     }
 
     @Override
@@ -368,21 +484,6 @@ public class ServerBot extends ServerPlayer {
         }
     }
 
-    @Override
-    public void doTick() {
-        if (this.hurtTime > 0) {
-            this.hurtTime -= 1;
-        }
-
-        baseTick();
-        tickEffects();
-
-        this.lerpSteps = (int) this.zza;
-        this.animStep = this.run;
-        this.yRotO = this.getYRot();
-        this.xRotO = this.getXRot();
-    }
-
     public Location getLocation() {
         return getBukkitPlayer().getLocation();
     }
@@ -474,6 +575,67 @@ public class ServerBot extends ServerPlayer {
         this.move(MoverType.SELF, new Vec3(velocity.getX(), y, velocity.getZ()));
     }
 
+    public void faceLocation(Location loc) {
+        look(loc.toVector().subtract(getLocation().toVector()), false);
+    }
+
+    private void look(Vector dir, boolean keepYaw) {
+        float yaw, pitch;
+
+        if (keepYaw) {
+            yaw = this.getYHeadRot();
+            pitch = MathUtils.fetchPitch(dir);
+        } else {
+            float[] vals = MathUtils.fetchYawPitch(dir);
+            yaw = vals[0];
+            pitch = vals[1];
+
+            sendPacket(new ClientboundRotateHeadPacket(this, (byte) (yaw * 256 / 360f)));
+        }
+
+        setRot(yaw, pitch);
+        this.getBukkitEntity().setRotation(yaw, pitch);
+    }
+
+    public void punch() {
+        swing(InteractionHand.MAIN_HAND);
+    }
+
+    public void attack(Entity target) {
+        super.attack(target);
+        punch();
+    }
+
+    public void setItem(org.bukkit.inventory.ItemStack item, EquipmentSlot slot) {
+        if (item == null) {
+            item = defaultItem;
+        }
+
+        this.detectEquipmentUpdates();
+        if (slot == EquipmentSlot.MAINHAND) {
+            getBukkitPlayer().getInventory().setItemInMainHand(item);
+            setItemInHand(InteractionHand.MAIN_HAND, CraftItemStack.asNMSCopy(item));
+        } else if (slot == EquipmentSlot.OFFHAND) {
+            getBukkitPlayer().getInventory().setItemInOffHand(item);
+            setItemInHand(InteractionHand.OFF_HAND, CraftItemStack.asNMSCopy(item));
+        }
+
+        sendPacket(new ClientboundSetEquipmentPacket(getId(), new ArrayList<>(Collections.singletonList(
+            new Pair<>(slot, CraftItemStack.asNMSCopy(item))
+        ))));
+    }
+
+    public void dropAll() {
+        getInventory().dropAll();
+        for (EquipmentSlot slot : EquipmentSlot.values()) {
+            setItem(null, slot);
+        }
+    }
+
+    public void setBotAction(BotAction botAction) {
+        this.newAction = botAction;
+    }
+
     public static ServerBot getBot(ServerPlayer player) {
         ServerBot bot = null;
         for (ServerBot b : bots) {
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/Actions.java b/src/main/java/top/leavesmc/leaves/bot/agent/Actions.java
new file mode 100644
index 0000000000000000000000000000000000000000..2e0fd0a6366cab8dc84c8aa1845f017c41666d6d
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/Actions.java
@@ -0,0 +1,49 @@
+package top.leavesmc.leaves.bot.agent;
+
+import top.leavesmc.leaves.bot.agent.action.AttackAction;
+import top.leavesmc.leaves.bot.agent.action.BreakBlockAction;
+import top.leavesmc.leaves.bot.agent.action.DropAction;
+import top.leavesmc.leaves.bot.agent.action.RotateAction;
+import top.leavesmc.leaves.bot.agent.action.StopAction;
+import top.leavesmc.leaves.bot.agent.action.UseItemAction;
+import top.leavesmc.leaves.bot.agent.action.UseItemOnAction;
+
+import java.util.HashSet;
+import java.util.Set;
+
+public class Actions {
+
+    private static final Set<BotAction> actions = new HashSet<>();
+
+    public static void registerAll() {
+        register(new AttackAction());
+        register(new DropAction());
+        register(new RotateAction());
+        register(new UseItemAction());
+        register(new UseItemOnAction());
+        register(new StopAction());
+        register(new BreakBlockAction());
+    }
+
+    public static void register(BotAction action) {
+        for (BotAction a : actions) {
+            if (a.getName().equals(action.getName())) {
+                return;
+            }
+        }
+        actions.add(action);
+    }
+
+    public static Set<BotAction> getAll() {
+        return actions;
+    }
+
+    public static BotAction getForName(String name) {
+        for (BotAction a : actions) {
+            if (a.getName().equals(name)) {
+                return a;
+            }
+        }
+        return null;
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/BotAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/BotAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..dd19f41fd5e1ad27637c0c3a8e96e7c17a96f891
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/BotAction.java
@@ -0,0 +1,42 @@
+package top.leavesmc.leaves.bot.agent;
+
+import net.minecraft.server.level.ServerPlayer;
+import top.leavesmc.leaves.bot.ServerBot;
+
+public abstract class BotAction {
+
+    private final String name;
+    private boolean cancel;
+    private int tickDelay;
+
+    public BotAction(String name) {
+        this.name = name;
+        this.cancel = false;
+        this.tickDelay = 20;
+    }
+
+    public String getName() {
+        return name;
+    }
+
+    public int getTickDelay() {
+        return tickDelay;
+    }
+
+    public BotAction setTickDelay(int tickDelay) {
+        this.tickDelay = tickDelay;
+        return this;
+    }
+
+    public boolean isCancel() {
+        return cancel;
+    }
+
+    public void setCancel(boolean cancel) {
+        this.cancel = cancel;
+    }
+
+    public abstract BotAction getNew(int tickDelay, ServerPlayer player);
+
+    public abstract void tick(ServerBot bot);
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/AttackAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/AttackAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..b69de7c67d39a84310f6105ae0619eb90b278cb8
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/AttackAction.java
@@ -0,0 +1,26 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import net.minecraft.world.phys.EntityHitResult;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class AttackAction extends BotAction {
+
+    public AttackAction() {
+        super("attack");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new AttackAction().setTickDelay(tickDelay);
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        EntityHitResult result = bot.getTargetEntity(3);
+         if (result != null) {
+             bot.attack(result.getEntity());
+         }
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/BreakBlockAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/BreakBlockAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..0f274eb3225581f9b870d7c519cd3159215f6de3
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/BreakBlockAction.java
@@ -0,0 +1,57 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.core.BlockPos;
+import net.minecraft.server.level.ServerPlayer;
+import net.minecraft.world.level.block.state.BlockState;
+import org.bukkit.block.Block;
+import org.bukkit.craftbukkit.block.CraftBlock;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class BreakBlockAction extends BotAction {
+    public BreakBlockAction() {
+        super("break");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new BreakBlockAction().setTickDelay(0);
+    }
+
+    private BlockPos lastPos = null;
+
+    private float damage = 0.0F;
+
+    @Override
+    public void tick(ServerBot bot) {
+        Block block = bot.getBukkitEntity().getTargetBlock(4);
+        if (block != null) {
+            BlockPos pos = ((CraftBlock) block).getPosition();
+
+            if (lastPos == null) {
+                lastPos = pos;
+                damage = 0.0F;
+            }
+
+            if (!lastPos.equals(pos)) {
+                lastPos = pos;
+                damage = 0.0F;
+            }
+
+            BlockState iblockdata = bot.level.getBlockState(lastPos);
+            if (!iblockdata.isAir()) {
+                bot.punch();
+                damage += iblockdata.getDestroyProgress(bot, bot.level, lastPos) * 5.0F;
+
+                int k = (int) (damage * 10.0F);
+                bot.level.destroyBlockProgress(bot.getId(), lastPos, k);
+
+                if (damage >= 1.0F) {
+                    bot.gameMode.destroyAndAck(lastPos, 0, "destroyed");
+                    bot.level.destroyBlockProgress(bot.getId(), lastPos, -1);
+                    damage = 0.0F;
+                }
+            }
+        }
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/DropAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/DropAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..28cdf84e0e0dddbb796a088915f912f5224994f6
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/DropAction.java
@@ -0,0 +1,22 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class DropAction extends BotAction {
+    public DropAction() {
+        super("drop");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new DropAction().setTickDelay(0);
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        bot.dropAll();
+        this.setCancel(true);
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/RotateAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/RotateAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..0ecc3a1dabb3af41b55278f94a5eba2c76585c15
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/RotateAction.java
@@ -0,0 +1,29 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class RotateAction extends BotAction {
+    public RotateAction() {
+        super("rotate");
+    }
+
+    private ServerPlayer player;
+
+    public BotAction setPlayer(ServerPlayer player) {
+        this.player = player;
+        return this;
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new RotateAction().setPlayer(player).setTickDelay(0);
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        bot.faceLocation(player.getBukkitEntity().getLocation());
+        this.setCancel(true);
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/StopAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/StopAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..ec47646ca94b2eab55ac0f32de859f10867f87f3
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/StopAction.java
@@ -0,0 +1,21 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class StopAction extends BotAction {
+    public StopAction() {
+        super("stop");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new StopAction();
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        this.setCancel(true);
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..7d12bc08b92cffbddf29b60fbaff2f2a43c4867e
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemAction.java
@@ -0,0 +1,24 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import net.minecraft.world.InteractionHand;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class UseItemAction extends BotAction {
+    public UseItemAction() {
+        super("use");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new UseItemAction().setTickDelay(tickDelay);
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        bot.getInventory().getSelected().use(bot.getLevel(), bot, InteractionHand.MAIN_HAND);
+        bot.punch();
+        bot.updateItemInMainHand();
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemOnAction.java b/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemOnAction.java
new file mode 100644
index 0000000000000000000000000000000000000000..d32cf3ddb83a8e9f18fc2a2bb19d4e5c76df9296
--- /dev/null
+++ b/src/main/java/top/leavesmc/leaves/bot/agent/action/UseItemOnAction.java
@@ -0,0 +1,29 @@
+package top.leavesmc.leaves.bot.agent.action;
+
+import net.minecraft.server.level.ServerPlayer;
+import net.minecraft.world.InteractionHand;
+import net.minecraft.world.phys.BlockHitResult;
+import net.minecraft.world.phys.HitResult;
+import top.leavesmc.leaves.bot.ServerBot;
+import top.leavesmc.leaves.bot.agent.BotAction;
+
+public class UseItemOnAction extends BotAction {
+    public UseItemOnAction() {
+        super("use_on");
+    }
+
+    @Override
+    public BotAction getNew(int tickDelay, ServerPlayer player) {
+        return new UseItemOnAction().setTickDelay(tickDelay);
+    }
+
+    @Override
+    public void tick(ServerBot bot) {
+        HitResult result = bot.getRayTrace(4);
+        if (result != null && result.getType() == HitResult.Type.BLOCK) {
+            bot.gameMode.useItemOn(bot, bot.getLevel(), bot.getItemInHand(InteractionHand.MAIN_HAND), InteractionHand.MAIN_HAND, (BlockHitResult) result);
+            bot.punch();
+            bot.updateItemInMainHand();
+        }
+    }
+}
diff --git a/src/main/java/top/leavesmc/leaves/util/MathUtils.java b/src/main/java/top/leavesmc/leaves/util/MathUtils.java
index acdef051d6d4eb4e0d957bfbd7f205827c2f23a9..d6a809569455872d08aeab81b174024d2bc3b53a 100644
--- a/src/main/java/top/leavesmc/leaves/util/MathUtils.java
+++ b/src/main/java/top/leavesmc/leaves/util/MathUtils.java
@@ -3,6 +3,8 @@ package top.leavesmc.leaves.util;
 import org.bukkit.util.NumberConversions;
 import org.bukkit.util.Vector;
 
+import java.util.regex.Pattern;
+
 public class MathUtils {
     // Lag ?
     public static void clean(Vector vector) {
@@ -10,4 +12,67 @@ public class MathUtils {
         if (!NumberConversions.isFinite(vector.getY())) vector.setY(0);
         if (!NumberConversions.isFinite(vector.getZ())) vector.setZ(0);
     }
+
+    private static final Pattern numericPattern = Pattern.compile("[0-9]*");
+    public static boolean isNumeric(String str){
+        return numericPattern.matcher(str).matches();
+    }
+
+    public static float[] fetchYawPitch(Vector dir) {
+        double x = dir.getX();
+        double z = dir.getZ();
+
+        float[] out = new float[2];
+
+        if (x == 0.0D && z == 0.0D) {
+            out[1] = (float) (dir.getY() > 0.0D ? -90 : 90);
+        }
+
+        else {
+            double theta = Math.atan2(-x, z);
+            out[0] = (float) Math.toDegrees((theta + 6.283185307179586D) % 6.283185307179586D);
+
+            double x2 = NumberConversions.square(x);
+            double z2 = NumberConversions.square(z);
+            double xz = Math.sqrt(x2 + z2);
+            out[1] = (float) Math.toDegrees(Math.atan(-dir.getY() / xz));
+        }
+
+        return out;
+    }
+
+    public static float fetchPitch(Vector dir) {
+        double x = dir.getX();
+        double z = dir.getZ();
+
+        float result;
+
+        if (x == 0.0D && z == 0.0D) {
+            result = (float) (dir.getY() > 0.0D ? -90 : 90);
+        }
+
+        else {
+            double x2 = NumberConversions.square(x);
+            double z2 = NumberConversions.square(z);
+            double xz = Math.sqrt(x2 + z2);
+            result = (float) Math.toDegrees(Math.atan(-dir.getY() / xz));
+        }
+
+        return result;
+    }
+
+    public static Vector getDirection(double rotX, double rotY) {
+        Vector vector = new Vector();
+
+        rotX = Math.toRadians(rotX);
+        rotY = Math.toRadians(rotY);
+
+        double xz = Math.abs(Math.cos(rotY));
+
+        vector.setX(-Math.sin(rotX) * xz);
+        vector.setZ(Math.cos(rotX) * xz);
+        vector.setY(-Math.sin(rotY));
+
+        return vector;
+    }
 }
